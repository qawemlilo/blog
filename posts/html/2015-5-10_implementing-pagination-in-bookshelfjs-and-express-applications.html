<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A blog about Web and Software development using Node.js, JavaScript, and PHP!">
<meta name="author" content="Qawelesizwe Mlilo">
<meta name="generator" content="Node Blogger" />

<title>Implementing Pagination in Bookshelf.js and Express applications</title>

<link rel="alternate" type="application/rss+xml" title="RSS Feed for blg.ragingflame.co.za" href="/rss" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<link href="/css/style_v1475776547249.css" rel="stylesheet">
<link href="http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700&amp;subset=latin,cyrillic-ext" rel="stylesheet" />

<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="navmenu navmenu-default navmenu-fixed-left offcanvas-sm">

      <button type="button" style="margin-right: 10px; margin-top: 5px; color:#fff" class="close hidden-md hidden-lg pull-right" aria-label="Close" data-toggle="offcanvas" data-target=".navmenu">
        <span aria-hidden="true">&times;</span>
      </button>

      <div class="text-center avatar">
        <a href="/">
          <img src="/img/q-mobile.png" class="img-circle desktop" title="Qawelesizwe Mlilo" alt="Qawelesizwe Mlilo" />
        </a>
      </div>

      <p class="description">
        Hi, my name is Qawelesizwe Mlilo (or Que). I'm a Lead Developer at a UK based Startup working remotely. This blog is about my programming (adventures || misadventures).<br><br><a href="https://github.com/qawemlilo/blog" target="_blank">Please send me a pull request for any corrections.</a>
      </p>

      <ul class="nav navmenu-nav">
        <li>
          <a href="/">Home</a>
        </li>
        <li >
          <a href="/about">About</a>
        </li>
        <li>
          <a href="https://github.com/qawemlilo" target="_blank">Projects</a>
        </li>
        <li>
          <a href="mailto:qawemlilo@gmail.com">Contact Me</a>
        </li>
      </ul>

      <ul class="list-inline social-media">
        <li>
          <a target="_blank" href="https://github.com/qawemlilo" title="Github" class="github">&nbsp;</a> 
        </li>
        <li>
          <a href="http://twitter.com/ragingflameblog" title="Follow me on Twitter" class="twitter">&nbsp;</a>
        </li>
        <li>
          <a href="https://plus.google.com/111595084798587457827/posts?hl=en&amp;partnerid=gplp0" title="Google+" class="google">&nbsp;</a>
        </li>
        <li>
          <a href="/rss" title="RSS" class="rss">&nbsp;</a>
        </li>
      </ul>
    </div>

    <div class="navbar navbar-inverse navbar-fixed-top hidden-md hidden-lg">
      <button type="button" class="navbar-toggle" data-toggle="offcanvas" data-target=".navmenu">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Raging Flame Blog</a>
    </div>

    <div class="container content">
      <div class="row">
        <div class="post blogpost"> 
          <h1>Implementing Pagination in Bookshelf.js and Express applications</h1>
      
          <div class="row date">
            <div class="dt col-xs-12 col-sm-8 col-md-8 col-lg-8">
              <span style="margin-right:10px">
                10 
                May 
                <a href="/2015">2015</a>
              </span>
              
              
                  &nbsp;
                  <span class="label label-default">
                    <a href="/tags/nodejs">nodejs</a>
                  </span> 
              
                  &nbsp;
                  <span class="label label-default">
                    <a href="/tags/node">node</a>
                  </span> 
              
                  &nbsp;
                  <span class="label label-default">
                    <a href="/tags/express">express</a>
                  </span> 
              
                  &nbsp;
                  <span class="label label-default">
                    <a href="/tags/bookshelf">bookshelf</a>
                  </span> 
              
                  &nbsp;
                  <span class="label label-default">
                    <a href="/tags/knex">knex</a>
                  </span> 
              
                  &nbsp;
                  <span class="label label-default">
                    <a href="/tags/jade">jade</a>
                  </span> 
              
                  &nbsp;
                  <span class="label label-default">
                    <a href="/tags/mysql">mysql</a>
                  </span> 
              
            </div>
            <div class="sharep col-xs-12 col-sm-4 col-md-4 col-lg-4" style="text-align:right">
              <ul class="list-inline list-unstyled">
                <li>
                  <a target="_blank" href="http://www.facebook.com/share.php?u=http://blog.ragingflame.co.za/2015/5/10/implementing-pagination-in-bookshelfjs-and-express-applications" class="share-fb" title="Share on Facebook">&nbsp;</a>
                </li>

                <li>
              <a target="_blank" href="http://twitter.com/home?status=http://blog.ragingflame.co.za/2015/5/10/implementing-pagination-in-bookshelfjs-and-express-applications" class="share-twitter" title="Share on Twitter">
               &nbsp;
              </a>                  
                </li>

                <li>
              <a target="_blank" href="http://reddit.com/submit?url=http://blog.ragingflame.co.za/2015/5/10/implementing-pagination-in-bookshelfjs-and-express-applications" class="share-reddit" title="Share on Reddit">
               &nbsp;
              </a>
                </li>

                <li>
              <a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=http://blog.ragingflame.co.za/2015/5/10/implementing-pagination-in-bookshelfjs-and-express-applications" class="share-linkedin" title="Share on LinkedIn">
               &nbsp;
              </a>
                </li>
              </ul>
           
            </div>
          </div>
      
          <p>Hi there my node curious friends. Today I would like to look at one of the most common components in application development, pagination. Almost every database driven application that you build requires some kind of pagination functionality.</p>
<p>If you have read some of my <a href="http://blog.ragingflame.co.za/2014/12/16/building-a-simple-api-with-express-and-bookshelfjs">previous posts</a>, you would have noticed how fond I am of Bookshelf.js. In this post, I am going to show you how to implement pagination using Bookshelf.js, Express, and Jade. We are going to take code used in a previous post, <a href="http://blog.ragingflame.co.za/2014/12/16/building-a-simple-api-with-express-and-bookshelfjs">Building a simple API with Express and Bookshelf.js</a>, modify it to be more modular, and then implement today's solution.</p>
<h3>Getting started</h3>
<p>This is how I am going to approach today's problem:</p>
<ol>
<li>Clone the repo from the aforementioned post: <code>git clone git@github.com:qawemlilo/node-mysql.git pagination</code></li>
<li>Break it down into an mvc-like modular architecture</li>
<li>Install view engines, jade</li>
<li>Create a base collection with pagination and other collections which extend the base collection</li>
<li>Create some controllers for loading views</li>
<li>Create a seeding script to populate the database with some random data</li>
</ol>
<h3>Creating Pagination</h3>
<p>The best way to implement pagination is to have a base collection that will be extended by other collections. This will ensure that all the collections we create will have pagination therefore enforcing DRY principles.</p>
<p>Before going any further, let us define what we want in our pagination:</p>
<ol>
<li>We need to have control over how many records are returned per query</li>
<li>We need to have the ability to sort the data by any column</li>
<li>We need to be able to create queries with multiple conditions</li>
<li>Easy view implementation - we should be able easily render the pagination in our views</li>
</ol>
<p>It is also important to note that we do not want to override any functionality of the Bookshelf Collection API - if someone used our collection without the full knowledge of pagination, everything should still work as expected.</p>
<p>Enough with the chit-chat, let's write some code.</p>
<p><strong>collections/base.js</strong></p>
<pre><code>&quot;use strict&quot;;

var Bookshelf = require('../dbconnect')();

Bookshelf.Collection = Bookshelf.Collection.extend({

  limit: 10,

  currentpage: 1,  

  pagination: {},

  base: '',

  paginationLimit: 10,

  queries: [],

  order: 'desc',

  /**
   * generates pagination data
   * @returns: {Object} - pagination data object
  */
  generatePagination: function (totalRecords) {
    var self = this;
    var totalpages = Math.ceil(totalRecords / self.limit);
    var groups = Math.ceil(totalpages / self.paginationLimit);
    var currentpage = self.currentpage;
    var items = [];
    var lastpage = totalpages;

    var next = currentpage &lt; lastpage ? currentpage + 1 : 1;
    var prev = currentpage &lt; 2 ? lastpage : currentpage - 1;

    var isFirstPage = currentpage === 1;
    var isLastPage = currentpage === lastpage;

    var highestF = currentpage + 2;
    var lowestF = currentpage - 2;
    var counterLimit = totalpages - 2;

    if (groups &gt; 1) {
      items.push(1);
      items.push(2);
      
      // if our current page is higher than 3
      if (lowestF &gt; 3) {
        items.push('...');

        //lets check if we our current page is towards the end
        if (lastpage - currentpage &lt; 2) {
           lowestF -=  3; // add more previous links       
        }
      }
      else {
        lowestF = 3; // lowest num to start looping from
      }

      for (var counter = lowestF; counter &lt; lowestF + 5; counter++) {
        if (counter &gt; counterLimit) {
          break;
        }

        items.push(counter);
      }
        
      // if current page not towards the end
      if (highestF &lt; totalpages - 2) {
        items.push('...');
      }

      items.push(lastpage - 1);
      items.push(lastpage);
    }
    else {
      // no complex pagination required
      for (var counter2 = 1; counter2 &lt;= lastpage; counter2++) {
        items.push(counter2);
      }
    }
   
    self.pagination = {
      items: items,
      currentpage: currentpage,
      base: self.base,
      isFirstPage: isFirstPage,
      isLastPage: isLastPage,
      next: next,
      prev: prev,
      total: totalRecords,
      limit: self.limit
    };

    return self.pagination;
  },

  /**
   * Creates pagination data
   * @returns: {Promise} - resolves with pagination object
  */
  paginate: function () {
    var self = this;
    var query = self.model.forge().query();
    var totalpages = 0;

    if (self.queries.length &gt; 1) {
      self.queries.forEach(function (where, i) {
        if (i === 0) {
          query.where(where[0], where[1], where[2]);
        }
        else {
          query.andWhere(where[0], where[1], where[2]);
        }
      });
    }
    
    return query.count('id AS total')
    .then(function (results) {
      totalpages = parseInt(results[0].total, 10);

      return self.generatePagination(totalpages);
    });
  },
  
  /**
   * fetches posts ordered by {sortColumn} and creates pagination
   * @returns: {Promise} - resolves with an Object
  */
  fetchBy: function (sortColumn, options, fetchOptions) {
    
    options = options || {};
    fetchOptions = fetchOptions || {};

    var self = this;
    var limit = parseInt(options.limit, 10) || self.limit;
    var currentpage = parseInt(options.page, 10) || self.currentpage;
    var order = options.order || self.order;

    self.queries = options.where || [];

    self.currentpage = currentpage;
    self.limit = limit;
    self.order = order;
    self.base = options.base || '';
    
    function fetch() {
      return self.constructor.forge()
      .query(function (query) {
        query.limit(limit);
        
        self.queries.forEach(function (where, i) {
          if (i === 0) {
            query.where(where[0], where[1], where[2]);
          }
          else {
            query.andWhere(where[0], where[1], where[2]);
          }
        });

        query.offset((currentpage - 1) * limit);
        query.orderBy(sortColumn, order);
      })
      .fetch(fetchOptions)
      .then(function (collection) {
        return {
          collection: collection,
          pagination: self.pagination
        };
      });
    }

    return self.paginate().then(fetch);
  }
});

module.exports = Bookshelf;
</code></pre>
<p>This is the base collection and below is an example of how it is extended:</p>
<p><strong>collections/posts.js</strong></p>
<pre><code>var Base = require('./base');
var Post = require('./models/post');

var Posts = Base.Collection.extend({
  model: Post
});

module.exports = Posts;
</code></pre>
<p>Whenever we want to fetch a paginated set of data we'll use the <code>.fetchBy</code> method. This method accepts 3 arguments:</p>
<ol>
<li>The first argument is the name of the sorting column</li>
<li>The second argument is an object with pagination options.</li>
<li>The last argument is an options object typically passed to the <code>fetch</code> method</li>
</ol>
<p>I have created a controller that handles pagination:</p>
<p><strong>controllers/posts.js</strong></p>
<pre><code>var Posts = require('../collections/posts');

module.exports.getPosts = function (req, res) {
  var posts = new Posts();
  var page = parseInt(req.query.p, 10);
  var limit = parseInt(req.query.limit, 10) || 10;
  var currentpage = page || 1;
  var order = req.query.order || &quot;asc&quot;;

  posts.fetchBy('published_at', {
    page: currentpage,
    limit: limit,
    order: order,
    where: [
      ['user_id', '=', 1],
      ['category_id', '=', 3]
    ]
  },
  {
    columns: ['id', 'slug', 'html', 'title'],
    withRelated: ['category']
  })
  .then(function (data) {
    res.render('posts', {
      pagination: data.pagination,
      posts: data.collection.toJSON()
    });
  })
  .catch(function (error) {
    res.status(500).send(error.message);
  });
};
</code></pre>
<p>All that is left now is to associate the <code>.getPosts</code> method with a route of your choice and create a <code>posts.jade</code> view.</p>
<p>In the spirit of the DRY principle I am going to create a jade mixin that accepts the pagination object and generates the pagination html. Its always a good idea to have a <code>mixins</code> directory inside your views directory.</p>
<p><strong>views/mixins/pagination.js</strong></p>
<pre><code>mixin paginate(pagination)
  if pagination.limit &lt; pagination.total
    .row(style='text-align: center')
      ul.pagination
        if (pagination.isFirstPage)
          li.disabled
            a(href='#') &amp;laquo; Prev
   
        else
          li
            a(href='?p=#{pagination.prev}') &amp;laquo; Prev
   
        each page, i in pagination.items
          if (page == '...')
            li.disabled
              a(href=&quot;#&quot;) ...
    
          else
            if (page == pagination.currentpage)
              li.active
                a(href='#{pagination.base}?p=#{page}') #{page}
            else
              li
                a(href='#{pagination.base}?p=#{page}') #{page}
   
        if (pagination.isLastPage)
          li.disabled
            a(href='#') Next &amp;raquo;
   
        else
          li
            a(href='#{pagination.base}?p=#{pagination.next}') Next &amp;raquo;
</code></pre>
<p>Below is an example of how you would use the mixin inside a jade view:</p>
<p><strong>views/posts.jade</strong></p>
<pre><code>extends layout

include mixins/pagination

block content
  div(class=&quot;col-sm-8 blog-main&quot;)
    each post, i in posts
      dl.dl-horizontal
        dt #{post.created_at}
        dd
          a(href=&quot;/posts/#{post.slug}&quot;) #{post.title}

    mixin paginate(pagination)
</code></pre>
<p>I have created a repo, <a href="https://github.com/qawemlilo/pagination">https://github.com/qawemlilo/pagination</a>, with a fully functional demo. This is how you can run it:</p>
<ol>
<li>Clone the repo: <code>git clone https://github.com/qawemlilo/pagination.git</code></li>
<li>Cd into the directory and install dependencies: <code>npm install</code></li>
<li>Update <code>config.js</code> with your db details</li>
<li>Create db tables and insert random data: <code>node migrate &amp;&amp; node seed</code></li>
<li>Start the server: <code>node app</code></li>
</ol>
<p>That's all folks! Please <a href="http://twitter.com/home?status=Implementing%20Pagination%20in%20%23Bookshelfjs%20and%20%23Express%20applications%20http%3A%2F%2Fblog.ragingflame.co.za%2F2015%2F5%2F10%2Fimplementing-pagination-in-bookshelfjs-and-express-applications%20%23nodejs%20%40ragingflameblog">share on twitter</a> if you enjoyed this post :)</p>

        </div>
        <div class="pagination-container">    
        
          <a href="/2015/4/1/how-i-build-nodejs-applications" title="Previous Post" class="pagination-arrow newer">Prev</a>
        
        
        
          <a href="/2015/12/6/how-i-built-my-static-blog-engine" title="Next Post" class="pagination-arrow older">Next</a>
        
      </div>
        
        <div id="disqus_thread"></div>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>

<script src="/js/script_v1475776547249.js"></script>
<script type="text/javascript">
    var disqus_shortname = 'ragingflameblog';
    var disqus_identifier = '/2015/5/10/implementing-pagination-in-bookshelfjs-and-express-applications';
    var disqus_title = 'Implementing Pagination in Bookshelf.js and Express applications';
    var disqus_url = 'http://blog.ragingflame.co.za/2015/5/10/implementing-pagination-in-bookshelfjs-and-express-applications';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41105756-1', 'ragingflame.co.za');
  ga('send', 'pageview');

</script>
</body>
</html>
